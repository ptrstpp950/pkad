pipeline {
    agent none
    environment {
        DOCKER_REGISTRY = "poznajkubernetes.azurecr.io"
        IMAGE_NAME = "pkad_jenkins"
        IMAGE_TAG = "${env.BRANCH_NAME}_${BUILD_ID}"
    }
    stages {
        stage('build') {
            agent { node { label 'docker' }}
            steps{
                withCredentials([
                    usernamePassword(
                        credentialsId: "docker_registry_credentials",
                        usernameVariable: 'REGISTRY_USER',
                        passwordVariable: 'REGISTRY_PASSWORD')]){
                    //sh 'echo "$REGISTRY_PASSWORD" | docker login -u REGISTRY_USER --password-stdin $DOCKER_REGISTRY'
                    sh 'echo $REGISTRY_USER'
                    sh 'echo $REGISTRY_PASSWORD'
                    sh 'docker login -u $REGISTRY_USER -p $REGISTRY_PASSWORD $DOCKER_REGISTRY'
                    sh "docker build -t $REGISTRY/${IMAGE_NAME}:$IMAGE_TAG ."
                    sh "docker push $REGISTRY/${IMAGE_NAME}:$IMAGE_TAG"
                }
                /*script{
                    docker.withRegistry("${DOCKER_REGISTRY}", 'docker_registry_credentials') {
                        def customImage = docker.build("${IMAGE_NAME}:${IMAGE_TAG}")
                        // Push thecontainer to the custom Registry
                        customImage.push()
                    }
                }*/
            }
        }
        stage('List pods') {
            agent {
                docker {
                    image 'poznajkubernetes/kubectl:v1.14'
                    args '-v /tmp:/tmp --entrypoint='
                }
            }
            steps{
                withKubeConfig(credentialsId: 'jenkins-kubeconfig', namespace: 'default') {
                    sh 'ls'
                    sh 'kubectl get pods'
                }
            }
        }
    }
}
